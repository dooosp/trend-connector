<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accidental Genius Generator</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #eee;
      padding: 20px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    header { text-align: center; padding: 40px 0; }
    h1 {
      font-size: 2rem;
      background: linear-gradient(90deg, #f39c12, #e74c3c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }
    .subtitle { color: #888; font-size: 0.9rem; }
    .usage-info {
      background: rgba(255,255,255,0.1);
      padding: 10px 20px;
      border-radius: 20px;
      display: inline-block;
      margin-top: 15px;
      font-size: 0.85rem;
    }
    .generate-btn {
      display: block;
      width: 100%;
      padding: 20px;
      font-size: 1.2rem;
      background: linear-gradient(90deg, #f39c12, #e74c3c);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      margin: 30px 0;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(243, 156, 18, 0.3);
    }
    .generate-btn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .result-card {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .notes-pair {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
    }
    .note-box {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    .note-title { font-weight: bold; color: #f39c12; word-break: break-word; }
    .note-folder { font-size: 0.8rem; color: #888; margin-top: 5px; }
    .connector { font-size: 2rem; color: #e74c3c; }
    .distance-badge {
      background: #e74c3c;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      display: inline-block;
      margin-bottom: 20px;
    }
    .idea-section { margin-top: 20px; }
    .idea-section h3 {
      color: #f39c12;
      margin-bottom: 10px;
      font-size: 1rem;
    }
    .idea-name {
      font-size: 1.5rem;
      color: #fff;
      margin-bottom: 10px;
    }
    .idea-desc { color: #ccc; line-height: 1.6; }
    .seed-sentence {
      background: linear-gradient(90deg, rgba(243,156,18,0.2), rgba(231,76,60,0.2));
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      border-left: 4px solid #f39c12;
      font-style: italic;
      font-size: 1.1rem;
    }
    .action-btns {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .action-btn {
      flex: 1;
      min-width: 100px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: #eee;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .action-btn:hover { background: rgba(255,255,255,0.1); }
    .action-btn.saved { background: #f39c12; color: #000; }
    .history-section { margin-top: 40px; }
    .history-section h2 {
      color: #888;
      font-size: 1rem;
      margin-bottom: 15px;
    }
    .history-item {
      background: rgba(255,255,255,0.03);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .history-item:hover { background: rgba(255,255,255,0.08); }
    .history-title { font-weight: bold; word-break: break-word; }
    .history-notes { font-size: 0.85rem; color: #888; margin-top: 5px; word-break: break-word; }
    .history-meta { text-align: right; font-size: 0.8rem; color: #666; white-space: nowrap; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #f39c12;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { color: #e74c3c; text-align: center; padding: 20px; }
    .empty { text-align: center; color: #666; padding: 40px; }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
      z-index: 100;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #1a1a2e;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 25px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-close {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .modal-body { white-space: pre-wrap; color: #ccc; line-height: 1.6; font-size: 0.9rem; }
    @media (max-width: 600px) {
      .notes-pair { grid-template-columns: 1fr; text-align: center; }
      .connector { transform: rotate(90deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Accidental Genius Generator</h1>
      <p class="subtitle">우연한 지식의 충돌에서 혁신이 태어납니다</p>
      <div class="usage-info" id="usageInfo">오늘 0/10 사용</div>
    </header>

    <button class="generate-btn" id="generateBtn" onclick="generate()">
      새로운 아이디어 생성
    </button>

    <div id="resultArea"></div>

    <div class="history-section">
      <h2>히스토리</h2>
      <div id="historyList"></div>
    </div>
  </div>

  <div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    let currentIdea = null;

    async function init() {
      await loadUsage();
      await loadHistory();
    }

    async function loadUsage() {
      try {
        const res = await fetch('/api/usage');
        const data = await res.json();
        document.getElementById('usageInfo').textContent =
          `오늘 ${data.todayUsage}/${data.dailyLimit} 사용`;
        document.getElementById('generateBtn').disabled =
          data.todayUsage >= data.dailyLimit;
      } catch (e) {
        console.error(e);
      }
    }

    async function generate() {
      const btn = document.getElementById('generateBtn');
      const resultArea = document.getElementById('resultArea');

      btn.disabled = true;
      btn.textContent = '생성 중...';
      resultArea.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>노트를 분석하고 아이디어를 융합하는 중...</p>
        </div>
      `;

      try {
        const res = await fetch('/api/generate');
        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error);
        }

        currentIdea = data.idea;
        renderIdea(data.idea);
        await loadHistory();
      } catch (e) {
        resultArea.innerHTML = `<div class="error">오류: ${e.message}</div>`;
      } finally {
        btn.textContent = '새로운 아이디어 생성';
        await loadUsage();
      }
    }

    function renderIdea(idea) {
      const r = idea.result;
      document.getElementById('resultArea').innerHTML = `
        <div class="result-card">
          <div class="notes-pair">
            <div class="note-box">
              <div class="note-title">${escapeHtml(idea.noteA.title)}</div>
              <div class="note-folder">${escapeHtml(idea.noteA.path.split('/')[0])}</div>
            </div>
            <div class="connector">⚡</div>
            <div class="note-box">
              <div class="note-title">${escapeHtml(idea.noteB.title)}</div>
              <div class="note-folder">${escapeHtml(idea.noteB.path.split('/')[0])}</div>
            </div>
          </div>

          <div class="distance-badge">이질성 점수: ${idea.distanceScore}/100</div>

          <div class="idea-section">
            <h3>숨겨진 공통점</h3>
            <p class="idea-desc">${escapeHtml(r.commonPrinciple || '-')}</p>
          </div>

          <div class="idea-section">
            <h3>비즈니스 아이디어</h3>
            <p class="idea-name">${escapeHtml(r.businessIdea?.name || '무제')}</p>
            <p class="idea-desc">${escapeHtml(r.businessIdea?.description || '-')}</p>
            <p class="idea-desc" style="margin-top:10px;color:#888;">
              대상: ${escapeHtml(r.businessIdea?.targetUser || '-')}
            </p>
          </div>

          <div class="idea-section">
            <h3>파급 효과</h3>
            <p class="idea-desc">${escapeHtml(r.impact || '-')}</p>
          </div>

          <div class="seed-sentence">
            "${escapeHtml(r.seedSentence || '...')}"
          </div>

          <div class="action-btns">
            <button class="action-btn ${idea.saved ? 'saved' : ''}"
                    onclick="toggleSave('${idea.id}')">
              ${idea.saved ? '저장됨' : '저장하기'}
            </button>
            <button class="action-btn" onclick="viewNote('${escapeHtml(idea.noteA.path)}')">
              노트A 보기
            </button>
            <button class="action-btn" onclick="viewNote('${escapeHtml(idea.noteB.path)}')">
              노트B 보기
            </button>
          </div>
        </div>
      `;
    }

    async function loadHistory() {
      try {
        const res = await fetch('/api/history');
        const data = await res.json();

        if (!data.history || data.history.length === 0) {
          document.getElementById('historyList').innerHTML =
            '<div class="empty">아직 생성된 아이디어가 없습니다</div>';
          return;
        }

        document.getElementById('historyList').innerHTML = data.history.map(h => `
          <div class="history-item" onclick="loadIdea('${h.id}')">
            <div>
              <div class="history-title">${h.saved ? '⭐ ' : ''}${escapeHtml(h.ideaName)}</div>
              <div class="history-notes">${escapeHtml(h.noteA)} ⚡ ${escapeHtml(h.noteB)}</div>
            </div>
            <div class="history-meta">
              <div>${h.distanceScore}점</div>
              <div>${new Date(h.createdAt).toLocaleDateString('ko-KR')}</div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }

    async function loadIdea(id) {
      try {
        const res = await fetch(`/api/history/${id}`);
        const data = await res.json();
        if (data.success) {
          currentIdea = data.idea;
          renderIdea(data.idea);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function toggleSave(id) {
      try {
        const res = await fetch(`/api/save/${id}`, { method: 'POST' });
        const data = await res.json();
        if (data.success && currentIdea) {
          currentIdea.saved = data.saved;
          renderIdea(currentIdea);
          await loadHistory();
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function viewNote(path) {
      try {
        const res = await fetch(`/api/preview?file=${encodeURIComponent(path)}`);
        const data = await res.json();
        document.getElementById('modalTitle').textContent = path;
        document.getElementById('modalBody').textContent = data.preview || '내용을 불러올 수 없습니다';
        document.getElementById('modal').classList.add('active');
      } catch (e) {
        alert('오류: ' + e.message);
      }
    }

    function closeModal(e) {
      if (!e || e.target.id === 'modal') {
        document.getElementById('modal').classList.remove('active');
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });

    init();
  </script>
</body>
</html>
